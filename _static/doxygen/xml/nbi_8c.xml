<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.1" xml:lang="en-US">
  <compounddef id="nbi_8c" kind="file" language="C++">
    <compoundname>nbi.c</compoundname>
    <includes refid="math_8h" local="no">math.h</includes>
    <includes refid="print_8h" local="yes">print.h</includes>
    <includes refid="ascot5_8h" local="yes">ascot5.h</includes>
    <includes refid="consts_8h" local="yes">consts.h</includes>
    <includes refid="physlib_8h" local="yes">physlib.h</includes>
    <includes refid="particle_8h" local="yes">particle.h</includes>
    <includes refid="random_8h" local="yes">random.h</includes>
    <includes refid="suzuki_8h" local="yes">suzuki.h</includes>
    <includes refid="B__field_8h" local="yes">B_field.h</includes>
    <includes refid="plasma_8h" local="yes">plasma.h</includes>
    <includes refid="wall_8h" local="yes">wall.h</includes>
    <includes refid="nbi_8h" local="yes">nbi.h</includes>
    <includes refid="diag_8h" local="yes">diag.h</includes>
    <includes refid="dist__5D_8h" local="yes">diag/dist_5D.h</includes>
    <incdepgraph>
      <node id="37">
        <label>diag/dist_rho5D.h</label>
        <link refid="dist__rho5D_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="25">
        <label>suzuki.h</label>
        <link refid="suzuki_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="26">
        <label>plasma.h</label>
        <link refid="plasma_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="27" relation="include">
        </childnode>
        <childnode refid="28" relation="include">
        </childnode>
        <childnode refid="29" relation="include">
        </childnode>
      </node>
      <node id="35">
        <label>diag/dist_5D.h</label>
        <link refid="dist__5D_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="10">
        <label>particle.h</label>
        <link refid="particle_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="20" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="34">
        <label>diag.h</label>
        <link refid="diag_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
        <childnode refid="36" relation="include">
        </childnode>
        <childnode refid="37" relation="include">
        </childnode>
        <childnode refid="38" relation="include">
        </childnode>
        <childnode refid="39" relation="include">
        </childnode>
        <childnode refid="40" relation="include">
        </childnode>
        <childnode refid="41" relation="include">
        </childnode>
      </node>
      <node id="15">
        <label>../spline/interp.h</label>
        <link refid="interp_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="13">
        <label>Bfield/B_GS.h</label>
        <link refid="B__GS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="30">
        <label>wall.h</label>
        <link refid="wall_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="31" relation="include">
        </childnode>
        <childnode refid="32" relation="include">
        </childnode>
      </node>
      <node id="29">
        <label>plasma/plasma_1DS.h</label>
        <link refid="plasma__1DS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="24">
        <label>stdlib.h</label>
      </node>
      <node id="1">
        <label>nbi.c</label>
        <link refid="nbi_8c"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="6" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
        <childnode refid="9" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="25" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="33" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
        <childnode refid="35" relation="include">
        </childnode>
      </node>
      <node id="33">
        <label>nbi.h</label>
        <link refid="nbi_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="26" relation="include">
        </childnode>
        <childnode refid="30" relation="include">
        </childnode>
        <childnode refid="23" relation="include">
        </childnode>
        <childnode refid="34" relation="include">
        </childnode>
      </node>
      <node id="40">
        <label>diag/diag_orb.h</label>
        <link refid="diag__orb_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="4">
        <label>omp.h</label>
      </node>
      <node id="8">
        <label>consts.h</label>
        <link refid="consts_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
      </node>
      <node id="11">
        <label>B_field.h</label>
        <link refid="B__field_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="13" relation="include">
        </childnode>
        <childnode refid="14" relation="include">
        </childnode>
        <childnode refid="16" relation="include">
        </childnode>
        <childnode refid="17" relation="include">
        </childnode>
        <childnode refid="19" relation="include">
        </childnode>
      </node>
      <node id="22">
        <label>Efield/E_1DS.h</label>
        <link refid="E__1DS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="28">
        <label>plasma/plasma_1Dt.h</label>
        <link refid="plasma__1Dt_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="9">
        <label>physlib.h</label>
        <link refid="physlib_8h"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="8" relation="include">
        </childnode>
      </node>
      <node id="23">
        <label>random.h</label>
        <link refid="random_8h"/>
        <childnode refid="24" relation="include">
        </childnode>
      </node>
      <node id="12">
        <label>error.h</label>
        <link refid="error_8h"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="39">
        <label>diag/dist_com.h</label>
        <link refid="dist__com_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="41">
        <label>diag/diag_transcoef.h</label>
        <link refid="diag__transcoef_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="20">
        <label>E_field.h</label>
        <link refid="E__field_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
        <childnode refid="21" relation="include">
        </childnode>
        <childnode refid="22" relation="include">
        </childnode>
      </node>
      <node id="27">
        <label>plasma/plasma_1D.h</label>
        <link refid="plasma__1D_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="5">
        <label>time.h</label>
      </node>
      <node id="19">
        <label>Bfield/B_TC.h</label>
        <link refid="B__TC_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
      </node>
      <node id="18">
        <label>../linint/linint.h</label>
        <link refid="linint_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="14">
        <label>Bfield/B_2DS.h</label>
        <link refid="B__2DS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="21">
        <label>Efield/E_TC.h</label>
        <link refid="E__TC_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="11" relation="include">
        </childnode>
      </node>
      <node id="16">
        <label>Bfield/B_3DS.h</label>
        <link refid="B__3DS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="12" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>math.h</label>
        <link refid="math_8h"/>
        <childnode refid="2" relation="include">
        </childnode>
        <childnode refid="3" relation="include">
        </childnode>
      </node>
      <node id="36">
        <label>diag/dist_6D.h</label>
        <link refid="dist__6D_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="32">
        <label>wall/wall_3d.h</label>
        <link refid="wall__3d_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
      </node>
      <node id="7">
        <label>stdio.h</label>
      </node>
      <node id="38">
        <label>diag/dist_rho6D.h</label>
        <link refid="dist__rho6D_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="10" relation="include">
        </childnode>
      </node>
      <node id="17">
        <label>Bfield/B_STS.h</label>
        <link refid="B__STS_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
        <childnode refid="18" relation="include">
        </childnode>
        <childnode refid="15" relation="include">
        </childnode>
      </node>
      <node id="6">
        <label>print.h</label>
        <link refid="print_8h"/>
        <childnode refid="7" relation="include">
        </childnode>
      </node>
      <node id="31">
        <label>wall/wall_2d.h</label>
        <link refid="wall__2d_8h"/>
        <childnode refid="3" relation="include">
        </childnode>
      </node>
      <node id="3">
        <label>ascot5.h</label>
        <link refid="ascot5_8h"/>
        <childnode refid="4" relation="include">
        </childnode>
        <childnode refid="5" relation="include">
        </childnode>
      </node>
    </incdepgraph>
      <sectiondef kind="define">
      <memberdef kind="define" id="nbi_8c_1a78c99ffd76a7bb3c8c74db76207e9ab4" prot="public" static="no">
        <name>_XOPEN_SOURCE</name>
        <initializer>500</initializer>
        <briefdescription>
        </briefdescription>
        <detaileddescription>
<para>drand48 requires POSIX 1995 standard </para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="5" column="9" bodyfile="nbi.c" bodystart="5" bodyend="-1"/>
      </memberdef>
      </sectiondef>
      <sectiondef kind="func">
      <memberdef kind="function" id="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void nbi_inject</definition>
        <argsstring>(real *xyz, real *vxyz, real *efrac, nbi_injector *inj, random_data *rng)</argsstring>
        <name>nbi_inject</name>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>xyz</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>vxyz</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>efrac</declname>
        </param>
        <param>
          <type><ref refid="structnbi__injector" kindref="compound">nbi_injector</ref> *</type>
          <declname>inj</declname>
        </param>
        <param>
          <type><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref> *</type>
          <declname>rng</declname>
        </param>
        <briefdescription>
<para>Initialize a neutral marker from an injector. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>inj</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to injector data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>xyz</parametername>
</parameternamelist>
<parameterdescription>
<para>initialized marker&apos;s position in cartesian coordinates [m] </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>vxyz</parametername>
</parameternamelist>
<parameterdescription>
<para>initialized marker&apos;s velocity in cartesian coordinates [m/s] </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>efrac</parametername>
</parameternamelist>
<parameterdescription>
<para>what fraction of injector energy was assigned to this marker </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to random number generator data </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="307" column="6" bodyfile="nbi.c" bodystart="307" bodyend="362" declfile="nbi.c" declline="23" declcolumn="6"/>
      </memberdef>
      <memberdef kind="function" id="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void nbi_ionize</definition>
        <argsstring>(real *xyz, real *vxyz, real time, int *shinethrough, int anum, int znum, real mass, B_field_data *Bdata, plasma_data *plsdata, wall_data *walldata, random_data *rng)</argsstring>
        <name>nbi_ionize</name>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>xyz</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>vxyz</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref></type>
          <declname>time</declname>
        </param>
        <param>
          <type>int *</type>
          <declname>shinethrough</declname>
        </param>
        <param>
          <type>int</type>
          <declname>anum</declname>
        </param>
        <param>
          <type>int</type>
          <declname>znum</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref></type>
          <declname>mass</declname>
        </param>
        <param>
          <type><ref refid="structB__field__data" kindref="compound">B_field_data</ref> *</type>
          <declname>Bdata</declname>
        </param>
        <param>
          <type><ref refid="structplasma__data" kindref="compound">plasma_data</ref> *</type>
          <declname>plsdata</declname>
        </param>
        <param>
          <type><ref refid="structwall__data" kindref="compound">wall_data</ref> *</type>
          <declname>walldata</declname>
        </param>
        <param>
          <type><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref> *</type>
          <declname>rng</declname>
        </param>
        <briefdescription>
<para>Trace a neutral marker until it has ionized or hit wall. </para>
        </briefdescription>
        <detaileddescription>
<para>This function updates marker&apos;s position and velocity coordinates that are given as an input.</para>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>xyz</parametername>
</parameternamelist>
<parameterdescription>
<para>marker initial position in cartesian coordinates [m] </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>vxyz</parametername>
</parameternamelist>
<parameterdescription>
<para>marker initial velocity vector in cartesian coordinates [m/s] </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>time</parametername>
</parameternamelist>
<parameterdescription>
<para>time instance when marker was born [s] </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>shinethrough</parametername>
</parameternamelist>
<parameterdescription>
<para>flag indicating if the marker hit the wall and which tile </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>anum</parametername>
</parameternamelist>
<parameterdescription>
<para>marker atomic mass number </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>znum</parametername>
</parameternamelist>
<parameterdescription>
<para>marker charge number </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>mass</parametername>
</parameternamelist>
<parameterdescription>
<para>marker mass </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>Bdata</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to magnetic field data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>plsdata</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to plasma data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>walldata</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to wall data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>rng</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to random number generator data </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="382" column="6" bodyfile="nbi.c" bodystart="382" bodyend="478" declfile="nbi.c" declline="26" declcolumn="6"/>
      </memberdef>
      <memberdef kind="function" id="nbi_8c_1aa530236ad7d5792eed628c4c6f26c4e1" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>int</type>
        <definition>int nbi_init_offload</definition>
        <argsstring>(nbi_offload_data *offload_data, real **offload_array)</argsstring>
        <name>nbi_init_offload</name>
        <param>
          <type><ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref> *</type>
          <declname>offload_data</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> **</type>
          <declname>offload_array</declname>
        </param>
        <briefdescription>
<para>Load NBI data and prepare parameters for offload. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>offload_data</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to offload data struct </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offload_array</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to pointer to offload array</para>
</parameterdescription>
</parameteritem>
</parameterlist>
<simplesect kind="return"><para>zero if initialization succeeded. </para>
</simplesect>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="38" column="5" bodyfile="nbi.c" bodystart="38" bodyend="65"/>
      </memberdef>
      <memberdef kind="function" id="nbi_8c_1a5b349c25f536509d77d56a923483996d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void nbi_init</definition>
        <argsstring>(nbi_data *nbi, nbi_offload_data *offload_data, real *offload_array)</argsstring>
        <name>nbi_init</name>
        <param>
          <type><ref refid="structnbi__data" kindref="compound">nbi_data</ref> *</type>
          <declname>nbi</declname>
        </param>
        <param>
          <type><ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref> *</type>
          <declname>offload_data</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> *</type>
          <declname>offload_array</declname>
        </param>
        <briefdescription>
<para>Initialize NBI data struct on target. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>nbi</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to data struct on target </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offload_data</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to offload data struct </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offload_array</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to offload array </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="74" column="6" bodyfile="nbi.c" bodystart="74" bodyend="104"/>
      </memberdef>
      <memberdef kind="function" id="nbi_8c_1a2aece30b973ce906587694e5a00b8570" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void nbi_free_offload</definition>
        <argsstring>(nbi_offload_data *offload_data, real **offload_array)</argsstring>
        <name>nbi_free_offload</name>
        <param>
          <type><ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref> *</type>
          <declname>offload_data</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref> **</type>
          <declname>offload_array</declname>
        </param>
        <briefdescription>
<para>Free offload array. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>offload_data</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to offload data struct </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>offload_array</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to pointer to offload array </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="112" column="6" bodyfile="nbi.c" bodystart="112" bodyend="119"/>
      </memberdef>
      <memberdef kind="function" id="nbi_8c_1a17354cdba5a3d966f25a8f2e93a79e5d" prot="public" static="no" const="no" explicit="no" inline="no" virt="non-virtual">
        <type>void</type>
        <definition>void nbi_generate</definition>
        <argsstring>(particle *pout, int nprt, real t0, real t1, nbi_injector *inj, B_field_data *Bdata, plasma_data *plasma_data, wall_data *wall_data, random_data *random_data, diag_data *diag)</argsstring>
        <name>nbi_generate</name>
        <param>
          <type><ref refid="structparticle" kindref="compound">particle</ref> *</type>
          <declname>pout</declname>
        </param>
        <param>
          <type>int</type>
          <declname>nprt</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref></type>
          <declname>t0</declname>
        </param>
        <param>
          <type><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref></type>
          <declname>t1</declname>
        </param>
        <param>
          <type><ref refid="structnbi__injector" kindref="compound">nbi_injector</ref> *</type>
          <declname>inj</declname>
        </param>
        <param>
          <type><ref refid="structB__field__data" kindref="compound">B_field_data</ref> *</type>
          <declname>Bdata</declname>
        </param>
        <param>
          <type><ref refid="structplasma__data" kindref="compound">plasma_data</ref> *</type>
          <declname>plasma_data</declname>
        </param>
        <param>
          <type><ref refid="structwall__data" kindref="compound">wall_data</ref> *</type>
          <declname>wall_data</declname>
        </param>
        <param>
          <type><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref> *</type>
          <declname>random_data</declname>
        </param>
        <param>
          <type><ref refid="structdiag__data" kindref="compound">diag_data</ref> *</type>
          <declname>diag</declname>
        </param>
        <briefdescription>
<para>Generate NBI ions by injecting and tracing neutrals from an injector. </para>
        </briefdescription>
        <detaileddescription>
<para><parameterlist kind="param"><parameteritem>
<parameternamelist>
<parametername>pout</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer where generated markers are stored or NULL </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>nprt</parametername>
</parameternamelist>
<parameterdescription>
<para>number of markers to be injected or generated </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>t0</parametername>
</parameternamelist>
<parameterdescription>
<para>time when the injector is turned on </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>t1</parametername>
</parameternamelist>
<parameterdescription>
<para>time when the injector is turned off </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>inj</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to injector data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>Bdata</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to magnetic field data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername><ref refid="structplasma__data" kindref="compound">plasma_data</ref></parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to plasma data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername><ref refid="structwall__data" kindref="compound">wall_data</ref></parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to wall data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>random_data</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to random number generator data </para>
</parameterdescription>
</parameteritem>
<parameteritem>
<parameternamelist>
<parametername>diag</parametername>
</parameternamelist>
<parameterdescription>
<para>pointer to diagnostics data </para>
</parameterdescription>
</parameteritem>
</parameterlist>
</para>
        </detaileddescription>
        <inbodydescription>
        </inbodydescription>
        <location file="nbi.c" line="135" column="6" bodyfile="nbi.c" bodystart="135" bodyend="296"/>
      </memberdef>
      </sectiondef>
    <briefdescription>
<para>Functions for NBI simulation and particle generation. </para>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="normal"></highlight></codeline>
<codeline lineno="5" refid="nbi_8c_1a78c99ffd76a7bb3c8c74db76207e9ab4" refkind="member"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>_XOPEN_SOURCE<sp/>500<sp/></highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;<ref refid="math_8h" kindref="compound">math.h</ref>&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="print_8h" kindref="compound">print.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ascot5_8h" kindref="compound">ascot5.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="consts_8h" kindref="compound">consts.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="math_8h" kindref="compound">math.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="physlib_8h" kindref="compound">physlib.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="particle_8h" kindref="compound">particle.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="random_8h" kindref="compound">random.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="suzuki_8h" kindref="compound">suzuki.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="B__field_8h" kindref="compound">B_field.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="plasma_8h" kindref="compound">plasma.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="wall_8h" kindref="compound">wall.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="nbi_8h" kindref="compound">nbi.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="diag_8h" kindref="compound">diag.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="dist__5D_8h" kindref="compound">diag/dist_5D.h</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" kindref="member">nbi_inject</ref>(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>xyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>vxyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>efrac,<sp/><ref refid="structnbi__injector" kindref="compound">nbi_injector</ref>*<sp/>inj,</highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>*<sp/>rng);</highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" kindref="member">nbi_ionize</ref>(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>xyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>vxyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>time,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">*<sp/>shinethrough,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>anum,</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>znum,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>mass,<sp/><ref refid="structB__field__data" kindref="compound">B_field_data</ref>*<sp/>Bdata,<sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>*<sp/>plsdata,</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>*<sp/>walldata,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>*<sp/>rng);</highlight></codeline>
<codeline lineno="29"><highlight class="normal"></highlight></codeline>
<codeline lineno="38" refid="nbi_8c_1aa530236ad7d5792eed628c4c6f26c4e1" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1aa530236ad7d5792eed628c4c6f26c4e1" kindref="member">nbi_init_offload</ref>(<ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref>*<sp/>offload_data,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>**<sp/>offload_array)<sp/>{</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>err<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="print_8h_1a8520c71eb5db223009e5079e420bc398" kindref="member">print_out</ref>(VERBOSE_IO,<sp/></highlight><highlight class="stringliteral">&quot;\nNBI<sp/>input\n&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="print_8h_1a8520c71eb5db223009e5079e420bc398" kindref="member">print_out</ref>(VERBOSE_IO,<sp/></highlight><highlight class="stringliteral">&quot;Number<sp/>of<sp/>injectors<sp/>%d:\n&quot;</highlight><highlight class="normal">,<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a33a60c4d1ef8425bc59dfecd4d832d86" kindref="member">ninj</ref>);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i=0;<sp/>i&lt;offload_data-&gt;<ref refid="structnbi__offload__data_1a33a60c4d1ef8425bc59dfecd4d832d86" kindref="member">ninj</ref>;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="print_8h_1a8520c71eb5db223009e5079e420bc398" kindref="member">print_out</ref>(VERBOSE_IO,<sp/></highlight><highlight class="stringliteral">&quot;\n<sp/><sp/>Injector<sp/>ID<sp/>%d<sp/>(%d<sp/>beamlets)<sp/>Power:<sp/>%1.1e\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ac21d3fd0f2cb35767681e2cc071667d7" kindref="member">id</ref>[i],<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a4509b76be609cac77fc175823df89c39" kindref="member">n_beamlet</ref>[i],</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ad1f58dc2fe3fc230d5fc60f7cb66d4b2" kindref="member">power</ref>[i]);</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="print_8h_1a8520c71eb5db223009e5079e420bc398" kindref="member">print_out</ref>(VERBOSE_IO,</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>Anum<sp/>%d<sp/>Znum<sp/>%d<sp/>mass<sp/>%1.1e<sp/>amu<sp/>energy<sp/>%1.1e<sp/>eV\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a57e4df7b513b913642dc71625d183ce0" kindref="member">anum</ref>[i],<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a324bd22a5dc2a73306ac81039a86f479" kindref="member">znum</ref>[i],</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a5348fd72722c15d87a42b303ae1508a3" kindref="member">mass</ref>[i]<sp/>/<sp/><ref refid="consts_8h_1a0042abe6b0fe12725d0b111347ab7964" kindref="member">CONST_U</ref>,</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1aa51fe43fca712cfc9979521c349705a1" kindref="member">energy</ref>[i]<sp/>/<sp/><ref refid="consts_8h_1aa2d52037e91528e354a59fc909365f7c" kindref="member">CONST_E</ref>);</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="print_8h_1a8520c71eb5db223009e5079e420bc398" kindref="member">print_out</ref>(VERBOSE_IO,</highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/><sp/><sp/><sp/>Energy<sp/>fractions:<sp/>%1.1e<sp/>(Full)<sp/>%1.1e<sp/>(1/2)<sp/>%1.1e<sp/>(1/3)\n&quot;</highlight><highlight class="normal">,</highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[0],<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[1],</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[2]);</highlight></codeline>
<codeline lineno="55"><highlight class="normal"></highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Even<sp/>if<sp/>halo<sp/>fraction<sp/>is<sp/>zero,<sp/>the<sp/>divergences<sp/>should<sp/>be<sp/>nonzero</highlight></codeline>
<codeline lineno="57"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to<sp/>avoid<sp/>division<sp/>by<sp/>zero<sp/>during<sp/>evaluation.<sp/>Do<sp/>this<sp/>after<sp/>the</highlight></codeline>
<codeline lineno="58"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>input<sp/>has<sp/>been<sp/>printed<sp/>as<sp/>to<sp/>not<sp/>confuse<sp/>the<sp/>user<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(offload_data-&gt;<ref refid="structnbi__offload__data_1ad10a672462bb7f67638e4d0173208823" kindref="member">div_halo_frac</ref>[i]<sp/>==<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a2de00821d294e9382daa00363eaf0a3d" kindref="member">div_halo_h</ref>[i]<sp/>=<sp/>1e-10;</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a2120eb5e5b6b9072448356d80187de41" kindref="member">div_halo_v</ref>[i]<sp/>=<sp/>1e-10;</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>err;</highlight></codeline>
<codeline lineno="65"><highlight class="normal">}</highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="74" refid="nbi_8c_1a5b349c25f536509d77d56a923483996d" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1a5b349c25f536509d77d56a923483996d" kindref="member">nbi_init</ref>(<ref refid="structnbi__data" kindref="compound">nbi_data</ref>*<sp/>nbi,<sp/><ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref>*<sp/>offload_data,</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>offload_array)<sp/>{</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>idx<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a28a0988a5d563562d47d87be315973d1" kindref="member">ninj</ref><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a33a60c4d1ef8425bc59dfecd4d832d86" kindref="member">ninj</ref>;</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i=0;<sp/>i&lt;nbi-&gt;<ref refid="structnbi__data_1a28a0988a5d563562d47d87be315973d1" kindref="member">ninj</ref>;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a6df8610919c2d0adf71fd4fb28366df5" kindref="member">anum</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a57e4df7b513b913642dc71625d183ce0" kindref="member">anum</ref>[i];</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ab6405f49c6284f4441223d75055f4e35" kindref="member">znum</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a324bd22a5dc2a73306ac81039a86f479" kindref="member">znum</ref>[i];</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a0d88412779d6ce4f6842852577d64637" kindref="member">mass</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a5348fd72722c15d87a42b303ae1508a3" kindref="member">mass</ref>[i];</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a98149d434fcf1e10b3b9e1b6cc781be1" kindref="member">power</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ad1f58dc2fe3fc230d5fc60f7cb66d4b2" kindref="member">power</ref>[i];</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a8f382df18a541a7f5e78220d704043f1" kindref="member">energy</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1aa51fe43fca712cfc9979521c349705a1" kindref="member">energy</ref>[i];</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[0]<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[3*i+0];</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[1]<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[3*i+1];</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[2]<sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ae68e18b4bb51a1e69d170453d9f37524" kindref="member">efrac</ref>[3*i+2];</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1aee5a03a106a09a14d0b60ffb91024022" kindref="member">div_h</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a3fa39320e5608a3a61dfa524a45a8f13" kindref="member">div_h</ref>[i];</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1aea7880f5caeaa228fdeb7666069858fb" kindref="member">div_v</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a0d851ef1e71c74c188a556d6168edc68" kindref="member">div_v</ref>[i];</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ac04563ffe5fb880ee2a527ab215feffc" kindref="member">div_halo_frac</ref><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ad10a672462bb7f67638e4d0173208823" kindref="member">div_halo_frac</ref>[i];</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a92677add3fcb3a574f429750055433b0" kindref="member">div_halo_h</ref><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a2de00821d294e9382daa00363eaf0a3d" kindref="member">div_halo_h</ref>[i];</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ae9f35ca3e721f757859168b27890fbf2" kindref="member">div_halo_v</ref><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a2120eb5e5b6b9072448356d80187de41" kindref="member">div_halo_v</ref>[i];</highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a4992fdc3797eab500c2c784b0355cb27" kindref="member">id</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1ac21d3fd0f2cb35767681e2cc071667d7" kindref="member">id</ref>[i];</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ae5f0e8aff63eb521a0f26f1df2cc5f8b" kindref="member">n_beamlet</ref><sp/><sp/><sp/><sp/><sp/>=<sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a4509b76be609cac77fc175823df89c39" kindref="member">n_beamlet</ref>[i];</highlight></codeline>
<codeline lineno="94"><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n_beamlet<sp/>=<sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ae5f0e8aff63eb521a0f26f1df2cc5f8b" kindref="member">n_beamlet</ref>;</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a628de9e1a819e362c4e5c37f62f18ad4" kindref="member">beamlet_x</ref><sp/><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>0*n_beamlet]);</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1aa143d69ae485908e2c3de27742ded29c" kindref="member">beamlet_y</ref><sp/><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>1*n_beamlet]);</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1ace5199912e824f220215f106c01503d9" kindref="member">beamlet_z</ref><sp/><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>2*n_beamlet]);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1acd6eefa63429b5bf795607d9ea89b9c5" kindref="member">beamlet_dx</ref><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>3*n_beamlet]);</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1a8425d110584a5865a9764562f4cf5a70" kindref="member">beamlet_dy</ref><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>4*n_beamlet]);</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nbi-&gt;<ref refid="structnbi__data_1a6d5ff3b6d7fd3ead920cb27dc8da424b" kindref="member">inj</ref>[i].<ref refid="structnbi__injector_1abbae9f6d2bb1aafef7f45e212c7f0a1d" kindref="member">beamlet_dz</ref><sp/>=<sp/>&amp;(offload_array[idx<sp/>+<sp/>5*n_beamlet]);</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx<sp/>+=<sp/>6<sp/>*<sp/>n_beamlet;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="104"><highlight class="normal">}</highlight></codeline>
<codeline lineno="105"><highlight class="normal"></highlight></codeline>
<codeline lineno="112" refid="nbi_8c_1a2aece30b973ce906587694e5a00b8570" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1a2aece30b973ce906587694e5a00b8570" kindref="member">nbi_free_offload</ref>(<ref refid="structnbi__offload__data" kindref="compound">nbi_offload_data</ref>*<sp/>offload_data,</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>**<sp/>offload_array)<sp/>{</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i=0;<sp/>i&lt;offload_data-&gt;<ref refid="structnbi__offload__data_1a33a60c4d1ef8425bc59dfecd4d832d86" kindref="member">ninj</ref>;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a4509b76be609cac77fc175823df89c39" kindref="member">n_beamlet</ref>[i]<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/>offload_data-&gt;<ref refid="structnbi__offload__data_1a33a60c4d1ef8425bc59dfecd4d832d86" kindref="member">ninj</ref><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/>free(*offload_array);</highlight></codeline>
<codeline lineno="119"><highlight class="normal">}</highlight></codeline>
<codeline lineno="120"><highlight class="normal"></highlight></codeline>
<codeline lineno="135" refid="nbi_8c_1a17354cdba5a3d966f25a8f2e93a79e5d" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1a17354cdba5a3d966f25a8f2e93a79e5d" kindref="member">nbi_generate</ref>(<ref refid="structparticle" kindref="compound">particle</ref>*<sp/>pout,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nprt,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>t0,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>t1,<sp/><ref refid="structnbi__injector" kindref="compound">nbi_injector</ref>*<sp/>inj,</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structB__field__data" kindref="compound">B_field_data</ref>*<sp/>Bdata,<sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>*<sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>,</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>*<sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>*<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>,</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structdiag__data" kindref="compound">diag_data</ref>*<sp/>diag)<sp/>{</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nelements<sp/>=<sp/><ref refid="wall_8c_1ad33cd65b0688785d3822cbb48c480cda" kindref="member">wall_get_n_elements</ref>(<ref refid="structwall__data" kindref="compound">wall_data</ref>);</highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>eload<sp/><sp/><sp/>=<sp/>(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*)malloc(<sp/>nelements<sp/>*<sp/></highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>)<sp/>);</highlight></codeline>
<codeline lineno="142"><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>One<sp/>marker<sp/>contributes<sp/>to<sp/>a<sp/>distribution<sp/>as<sp/>weight*dt.<sp/>If<sp/>beams<sp/>are<sp/>on</highlight></codeline>
<codeline lineno="144"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>for<sp/>a<sp/>set<sp/>time,<sp/>use<sp/>the<sp/>time<sp/>interval<sp/>as<sp/>dt.<sp/>If<sp/>beams<sp/>are<sp/>on<sp/>indefinitely</highlight></codeline>
<codeline lineno="145"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>(t1=t0)<sp/>then<sp/>use<sp/>dt=1.0<sp/>s<sp/>since<sp/>then<sp/>we<sp/>don&apos;t<sp/>need<sp/>to<sp/>normalize<sp/>the</highlight></codeline>
<codeline lineno="146"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>distribution<sp/>afterwards<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>dt<sp/>=<sp/>t1<sp/>-<sp/>t0;</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(dt<sp/>==<sp/>0.0)<sp/>{</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>dt<sp/>=<sp/>1.0;</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Set<sp/>marker<sp/>weights<sp/>assuming<sp/>a<sp/>large<sp/>number<sp/>is<sp/>created<sp/>so<sp/>that<sp/>the<sp/>energy</highlight></codeline>
<codeline lineno="152"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>fractions<sp/>of<sp/>generated<sp/>markers<sp/>are<sp/>close<sp/>to<sp/>the<sp/>injector<sp/>values<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>f<sp/><sp/>=<sp/><sp/><sp/><sp/><sp/>1.0<sp/>*<sp/>inj-&gt;<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[0]<sp/>+<sp/>(1.0/2)<sp/>*<sp/>inj-&gt;<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[1]</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>+<sp/>(1.0/3)<sp/>*<sp/>inj-&gt;<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[2];</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>weight<sp/>=<sp/>(inj-&gt;<ref refid="structnbi__injector_1a98149d434fcf1e10b3b9e1b6cc781be1" kindref="member">power</ref><sp/>/<sp/>inj-&gt;<ref refid="structnbi__injector_1a8f382df18a541a7f5e78220d704043f1" kindref="member">energy</ref><sp/>)<sp/>/<sp/>(<sp/>f<sp/>*<sp/>nprt<sp/>);</highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ngenerated<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="158"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/>#pragma<sp/>omp<sp/>parallel<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nprt;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structparticle" kindref="compound">particle</ref><sp/>ptemp,<sp/>*p;</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>xyz[3],<sp/>vxyz[3];</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>charge,<sp/>gamma,<sp/>efrac;</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>anum<sp/><sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a6df8610919c2d0adf71fd4fb28366df5" kindref="member">anum</ref>;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>znum<sp/><sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1ab6405f49c6284f4441223d75055f4e35" kindref="member">znum</ref>;</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>mass<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a0d88412779d6ce4f6842852577d64637" kindref="member">mass</ref>;</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>time<sp/>=<sp/>t0<sp/>+<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng)<sp/>*<sp/>(t1-t0);</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>walltile<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" kindref="member">nbi_inject</ref>(xyz,<sp/>vxyz,<sp/>&amp;efrac,<sp/>inj,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" kindref="member">nbi_ionize</ref>(xyz,<sp/>vxyz,<sp/>time,<sp/>&amp;walltile,<sp/>anum,<sp/>znum,<sp/>mass,<sp/>Bdata,</highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>,<sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>);</highlight></codeline>
<codeline lineno="172"><highlight class="normal"></highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(walltile<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>eload[walltile]<sp/>+=<sp/>weight;</highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>idx;</highlight></codeline>
<codeline lineno="178"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#pragma<sp/>omp<sp/>critical</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>{</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>idx<sp/>=<sp/>ngenerated;</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ngenerated++;</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>rpz[3],<sp/>vrpz[3];</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a484ec0cbb3628bc8451a4f82ba292803" kindref="member">math_xyz2rpz</ref>(xyz,<sp/>rpz);</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a2926fc9962621a0a75d463e6b43f449d" kindref="member">math_vec_xyz2rpz</ref>(vxyz,<sp/>vrpz,<sp/>rpz[1]);</highlight></codeline>
<codeline lineno="187"><highlight class="normal"></highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Convert<sp/>state<sp/>to<sp/>input<sp/>and<sp/>store<sp/>in<sp/>output<sp/>array<sp/>if<sp/>requested<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gamma<sp/>=<sp/><ref refid="physlib_8h_1ae912c3e48025bd66c3f2ec2228702941" kindref="member">physlib_gamma_vnorm</ref>(<ref refid="math_8h_1adfcdc12f390386bae35dfed59f73e247" kindref="member">math_norm</ref>(vrpz));</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>charge<sp/>=<sp/>1<sp/>*<sp/><ref refid="consts_8h_1aa2d52037e91528e354a59fc909365f7c" kindref="member">CONST_E</ref>;<sp/></highlight><highlight class="comment">//<sp/>Singly<sp/>ionized<sp/>always</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(pout<sp/>!=<sp/>NULL)<sp/>{</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a91589c36968e810182fc94133eef3c02" kindref="member">r</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[0];</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a438bb2444022de59231b10dab1e4b564" kindref="member">phi</ref><sp/><sp/><sp/><sp/>=<sp/>rpz[1];</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a264fe4c41179e72afd1b6c8a824faf85" kindref="member">z</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[2];</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1aecd9f4d05154d2e7b8cd27f9de0432a5" kindref="member">p_r</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[0]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a4a00f5d0bf15810900c4c3fdddbdc4b2" kindref="member">p_phi</ref><sp/><sp/>=<sp/>vrpz[1]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1acf7ecd617b5b30e9179553b1e71e4a8e" kindref="member">p_z</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[2]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="198"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a1ebb08bda0afda6302c0123e775a5435" kindref="member">anum</ref><sp/><sp/><sp/>=<sp/>anum;</highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a7d39fdfca5945d3d964dac0fab061f2b" kindref="member">znum</ref><sp/><sp/><sp/>=<sp/>znum;</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a1b606e67922db122be89a7af32648714" kindref="member">charge</ref><sp/>=<sp/>charge;</highlight></codeline>
<codeline lineno="201"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a91fbaab5de85465656bc523801280cdf" kindref="member">mass</ref><sp/><sp/><sp/>=<sp/>mass;</highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1ad8132c4b267fb25d3bfda3306d06e6c3" kindref="member">id</ref><sp/><sp/><sp/><sp/><sp/>=<sp/>i+1;</highlight></codeline>
<codeline lineno="203"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a4e7606a8ab8fed05991d00c52377cff5" kindref="member">time</ref><sp/><sp/><sp/>=<sp/>time;</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[idx].<ref refid="structparticle_1a41682650216e3bae370addda7f7b9c1f" kindref="member">weight</ref><sp/>=<sp/>weight;</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;(pout[idx]);</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a91589c36968e810182fc94133eef3c02" kindref="member">r</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[0];</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a438bb2444022de59231b10dab1e4b564" kindref="member">phi</ref><sp/><sp/><sp/><sp/>=<sp/>rpz[1];</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a264fe4c41179e72afd1b6c8a824faf85" kindref="member">z</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[2];</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1aecd9f4d05154d2e7b8cd27f9de0432a5" kindref="member">p_r</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[0]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="212"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a4a00f5d0bf15810900c4c3fdddbdc4b2" kindref="member">p_phi</ref><sp/><sp/>=<sp/>vrpz[1]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1acf7ecd617b5b30e9179553b1e71e4a8e" kindref="member">p_z</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[2]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a1ebb08bda0afda6302c0123e775a5435" kindref="member">anum</ref><sp/><sp/><sp/>=<sp/>anum;</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a7d39fdfca5945d3d964dac0fab061f2b" kindref="member">znum</ref><sp/><sp/><sp/>=<sp/>znum;</highlight></codeline>
<codeline lineno="216"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a1b606e67922db122be89a7af32648714" kindref="member">charge</ref><sp/>=<sp/>charge;</highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a91fbaab5de85465656bc523801280cdf" kindref="member">mass</ref><sp/><sp/><sp/>=<sp/>mass;</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1ad8132c4b267fb25d3bfda3306d06e6c3" kindref="member">id</ref><sp/><sp/><sp/><sp/><sp/>=<sp/>i+1;</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a4e7606a8ab8fed05991d00c52377cff5" kindref="member">time</ref><sp/><sp/><sp/>=<sp/>time;</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ptemp.<ref refid="structparticle_1a41682650216e3bae370addda7f7b9c1f" kindref="member">weight</ref><sp/>=<sp/>weight;</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>p<sp/>=<sp/>&amp;ptemp;</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="223"><highlight class="normal"></highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Convert<sp/>input<sp/>to<sp/>state<sp/>and<sp/>state<sp/>to<sp/>sim.<sp/>struct<sp/>for<sp/>diagnostics*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="225"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structparticle__state" kindref="compound">particle_state</ref><sp/>ps;</highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structparticle__simd__fo" kindref="compound">particle_simd_fo</ref><sp/>pi,<sp/>pf;</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="particle_8c_1ab65075ed0209a55686c1009eb2041af0" kindref="member">particle_input_p_to_state</ref>(p,<sp/>&amp;ps,<sp/>Bdata);</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>j=0;<sp/>j&lt;<ref refid="ascot5_8h_1a6368ab06bbb536b220a367552186bbab" kindref="member">NSIMD</ref>;<sp/>j++)<sp/>{</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pi.id[j]<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pf.id[j]<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="231"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="particle_8c_1a275c199f15c1a8f46a48decfb6908b71" kindref="member">particle_state_to_fo</ref>(&amp;ps,<sp/>0,<sp/>&amp;pi,<sp/>0,<sp/>Bdata);</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="particle_8c_1afb47cf7aacb7f1d2aaae0ee5dc657229" kindref="member">particle_copy_fo</ref>(&amp;pi,<sp/>0,<sp/>&amp;pf,<sp/>0);</highlight></codeline>
<codeline lineno="234"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pf.time[0]<sp/>=<sp/>1.0;</highlight></codeline>
<codeline lineno="235"><highlight class="normal"></highlight></codeline>
<codeline lineno="236"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="diag_8c_1a04ac8d3800297d9cff3472e5908fcb6b" kindref="member">diag_update_fo</ref>(diag,<sp/>Bdata,<sp/>&amp;pf,<sp/>&amp;pi);</highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="239"><highlight class="normal"></highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Second<sp/>loop<sp/>but<sp/>this<sp/>time<sp/>we<sp/>don&apos;t<sp/>update<sp/>diagnostics.<sp/>Instead<sp/>we</highlight></codeline>
<codeline lineno="241"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>generate<sp/>markers<sp/>until<sp/>the<sp/>particle<sp/>struct<sp/>is<sp/>filled<sp/>(skip<sp/>this<sp/>loop</highlight></codeline>
<codeline lineno="242"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>if<sp/>markers<sp/>are<sp/>not<sp/>requested).<sp/>We<sp/>have<sp/>do<sp/>it<sp/>like<sp/>this<sp/>because<sp/>we<sp/>can</highlight></codeline>
<codeline lineno="243"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>either<sp/>fix<sp/>the<sp/>number<sp/>of<sp/>markers<sp/>to<sp/>be<sp/>generated<sp/>or<sp/>the<sp/>marker<sp/>weight</highlight></codeline>
<codeline lineno="244"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>before<sp/>the<sp/>simulation<sp/>loop<sp/>but<sp/>not<sp/>both.<sp/>Last<sp/>loop<sp/>fixed<sp/>weight<sp/>since</highlight></codeline>
<codeline lineno="245"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>it<sp/>is<sp/>required<sp/>by<sp/>the<sp/>diagnostics<sp/>(markers<sp/>generated<sp/>in<sp/>last<sp/>loop<sp/>need</highlight></codeline>
<codeline lineno="246"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/>*<sp/>to<sp/>be<sp/>reweighted).<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nionized<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nshined<sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(pout<sp/>==<sp/>NULL)<sp/>{<sp/>ngenerated<sp/>=<sp/>nprt;<sp/>}</highlight></codeline>
<codeline lineno="250"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/>#pragma<sp/>omp<sp/>parallel<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>ngenerated;<sp/>i<sp/>&lt;<sp/>nprt;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>xyz[3],<sp/>vxyz[3];</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>charge,<sp/>gamma,<sp/>efrac;</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>anum<sp/><sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a6df8610919c2d0adf71fd4fb28366df5" kindref="member">anum</ref>;</highlight></codeline>
<codeline lineno="255"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>znum<sp/><sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1ab6405f49c6284f4441223d75055f4e35" kindref="member">znum</ref>;</highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>mass<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a0d88412779d6ce4f6842852577d64637" kindref="member">mass</ref>;</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>time<sp/>=<sp/>t0<sp/>+<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng)<sp/>*<sp/>(t1-t0);</highlight></codeline>
<codeline lineno="258"><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>shinethrough<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">do</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" kindref="member">nbi_inject</ref>(xyz,<sp/>vxyz,<sp/>&amp;efrac,<sp/>inj,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>);</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" kindref="member">nbi_ionize</ref>(xyz,<sp/>vxyz,<sp/>time,<sp/>&amp;shinethrough,<sp/>anum,<sp/>znum,<sp/>mass,<sp/>Bdata,</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>,<sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>);</highlight></codeline>
<codeline lineno="264"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(shinethrough<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="265"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#pragma<sp/>omp<sp/>atomic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nshined++;</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(shinethrough<sp/>!=<sp/>0);</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>rpz[3],<sp/>vrpz[3];</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a484ec0cbb3628bc8451a4f82ba292803" kindref="member">math_xyz2rpz</ref>(xyz,<sp/>rpz);</highlight></codeline>
<codeline lineno="271"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a2926fc9962621a0a75d463e6b43f449d" kindref="member">math_vec_xyz2rpz</ref>(vxyz,<sp/>vrpz,<sp/>rpz[1]);</highlight></codeline>
<codeline lineno="272"><highlight class="normal"></highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>gamma<sp/><sp/>=<sp/><ref refid="physlib_8h_1ae912c3e48025bd66c3f2ec2228702941" kindref="member">physlib_gamma_vnorm</ref>(<ref refid="math_8h_1adfcdc12f390386bae35dfed59f73e247" kindref="member">math_norm</ref>(vrpz));</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>charge<sp/>=<sp/>1<sp/>*<sp/><ref refid="consts_8h_1aa2d52037e91528e354a59fc909365f7c" kindref="member">CONST_E</ref>;<sp/></highlight><highlight class="comment">//<sp/>Singly<sp/>ionized<sp/>always</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a91589c36968e810182fc94133eef3c02" kindref="member">r</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[0];</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a438bb2444022de59231b10dab1e4b564" kindref="member">phi</ref><sp/><sp/><sp/><sp/>=<sp/>rpz[1];</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a264fe4c41179e72afd1b6c8a824faf85" kindref="member">z</ref><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/>rpz[2];</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1aecd9f4d05154d2e7b8cd27f9de0432a5" kindref="member">p_r</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[0]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a4a00f5d0bf15810900c4c3fdddbdc4b2" kindref="member">p_phi</ref><sp/><sp/>=<sp/>vrpz[1]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1acf7ecd617b5b30e9179553b1e71e4a8e" kindref="member">p_z</ref><sp/><sp/><sp/><sp/>=<sp/>vrpz[2]<sp/>*<sp/>gamma<sp/>*<sp/>mass;</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a1ebb08bda0afda6302c0123e775a5435" kindref="member">anum</ref><sp/><sp/><sp/>=<sp/>anum;</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a7d39fdfca5945d3d964dac0fab061f2b" kindref="member">znum</ref><sp/><sp/><sp/>=<sp/>znum;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a1b606e67922db122be89a7af32648714" kindref="member">charge</ref><sp/>=<sp/>charge;</highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a91fbaab5de85465656bc523801280cdf" kindref="member">mass</ref><sp/><sp/><sp/>=<sp/>mass;</highlight></codeline>
<codeline lineno="285"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1ad8132c4b267fb25d3bfda3306d06e6c3" kindref="member">id</ref><sp/><sp/><sp/><sp/><sp/>=<sp/>i+1;</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a4e7606a8ab8fed05991d00c52377cff5" kindref="member">time</ref><sp/><sp/><sp/>=<sp/>time;</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a41682650216e3bae370addda7f7b9c1f" kindref="member">weight</ref><sp/>=<sp/>weight;</highlight></codeline>
<codeline lineno="288"><highlight class="normal"></highlight></codeline>
<codeline lineno="289"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>#pragma<sp/>omp<sp/>atomic</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>nionized++;</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/>weight<sp/>*=<sp/>((<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>)<sp/>nprt)<sp/>/<sp/>(nprt<sp/>+<sp/>nshined<sp/>+<sp/>nionized);</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>nprt;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pout[i].<ref refid="structparticle_1a41682650216e3bae370addda7f7b9c1f" kindref="member">weight</ref><sp/>=<sp/>weight;</highlight></codeline>
<codeline lineno="295"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="296"><highlight class="normal">}</highlight></codeline>
<codeline lineno="297"><highlight class="normal"></highlight></codeline>
<codeline lineno="307" refid="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1a8a317a542dc5d9500c43c244196fe6b3" kindref="member">nbi_inject</ref>(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>xyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>vxyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>efrac,<sp/><ref refid="structnbi__injector" kindref="compound">nbi_injector</ref>*<sp/>inj,</highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>*<sp/>rng)<sp/>{</highlight></codeline>
<codeline lineno="309"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Pick<sp/>a<sp/>random<sp/>beamlet<sp/>and<sp/>initialize<sp/>marker<sp/>there<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i_beamlet<sp/>=<sp/>floor(<ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng)<sp/>*<sp/>inj-&gt;<ref refid="structnbi__injector_1ae5f0e8aff63eb521a0f26f1df2cc5f8b" kindref="member">n_beamlet</ref>);</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/>xyz[0]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a628de9e1a819e362c4e5c37f62f18ad4" kindref="member">beamlet_x</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/>xyz[1]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1aa143d69ae485908e2c3de27742ded29c" kindref="member">beamlet_y</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/>xyz[2]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1ace5199912e824f220215f106c01503d9" kindref="member">beamlet_z</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="314"><highlight class="normal"></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Pick<sp/>marker<sp/>energy<sp/>based<sp/>on<sp/>the<sp/>energy<sp/>fractions<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>energy;</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>r<sp/>=<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng);</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(r<sp/>&lt;<sp/>inj-&gt;efrac[0])<sp/>{</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>energy<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a8f382df18a541a7f5e78220d704043f1" kindref="member">energy</ref>;</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*efrac<sp/>=<sp/>1.0;</highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(r<sp/>&lt;<sp/>inj-&gt;efrac[0]<sp/>+<sp/>inj-&gt;<ref refid="structnbi__injector_1a4babebabafe0a6231ef12c62705e3485" kindref="member">efrac</ref>[1])<sp/>{</highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>energy<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a8f382df18a541a7f5e78220d704043f1" kindref="member">energy</ref><sp/>/<sp/>2;</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*efrac<sp/>=<sp/>1.0/2;</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>energy<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a8f382df18a541a7f5e78220d704043f1" kindref="member">energy</ref><sp/>/<sp/>3;</highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*efrac<sp/>=<sp/>1.0/3;</highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="328"><highlight class="normal"></highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Calculate<sp/>vertical<sp/>and<sp/>horizontal<sp/>normals<sp/>for<sp/>beam<sp/>divergence<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>dir[3],<sp/>normalv[3],<sp/>normalh[3],<sp/>tmp[3];</highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/>dir[0]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1acd6eefa63429b5bf795607d9ea89b9c5" kindref="member">beamlet_dx</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/>dir[1]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1a8425d110584a5865a9764562f4cf5a70" kindref="member">beamlet_dy</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/><sp/><sp/>dir[2]<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1abbae9f6d2bb1aafef7f45e212c7f0a1d" kindref="member">beamlet_dz</ref>[i_beamlet];</highlight></codeline>
<codeline lineno="334"><highlight class="normal"></highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>phi<sp/><sp/><sp/>=<sp/>atan2(dir[1],<sp/>dir[0]);</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>theta<sp/>=<sp/>acos(dir[2]);</highlight></codeline>
<codeline lineno="337"><highlight class="normal"></highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/>normalv[0]<sp/>=<sp/>sin(theta+<ref refid="consts_8h_1a02b01cde332fa86c92d54802cce7f3d2" kindref="member">CONST_PI</ref>/2)<sp/>*<sp/>cos(phi);</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/>normalv[1]<sp/>=<sp/>sin(theta+<ref refid="consts_8h_1a02b01cde332fa86c92d54802cce7f3d2" kindref="member">CONST_PI</ref>/2)<sp/>*<sp/>sin(phi);</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/>normalv[2]<sp/>=<sp/>cos(theta+<ref refid="consts_8h_1a02b01cde332fa86c92d54802cce7f3d2" kindref="member">CONST_PI</ref>/2);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"></highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="math_8h_1abe0d82787eb750e38e7fbb791c575084" kindref="member">math_cross</ref>(dir,<sp/>normalv,<sp/>tmp);</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="math_8h_1a29911679af4275647fea8492f908bbd9" kindref="member">math_unit</ref>(tmp,<sp/>normalh);</highlight></codeline>
<codeline lineno="344"><highlight class="normal"></highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Assuming<sp/>isotropic<sp/>divergence<sp/>using<sp/>horizontal<sp/>value,</highlight></codeline>
<codeline lineno="346"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ignoring<sp/>halo<sp/>divergence<sp/>for<sp/>now<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/>r<sp/>=<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng);</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>div<sp/>=<sp/>inj-&gt;<ref refid="structnbi__injector_1aee5a03a106a09a14d0b60ffb91024022" kindref="member">div_h</ref><sp/>*<sp/>sqrt(log(1/(1-r)));</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>angle<sp/>=<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng)<sp/>*<sp/>2<sp/>*<sp/><ref refid="consts_8h_1a02b01cde332fa86c92d54802cce7f3d2" kindref="member">CONST_PI</ref>;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/>tmp[0]<sp/>=<sp/>dir[0]<sp/>+<sp/>div<sp/>*<sp/>(<sp/>cos(angle)*normalh[0]<sp/>+<sp/>sin(angle)*normalv[0]<sp/>);</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/>tmp[1]<sp/>=<sp/>dir[1]<sp/>+<sp/>div<sp/>*<sp/>(<sp/>cos(angle)*normalh[1]<sp/>+<sp/>sin(angle)*normalv[1]<sp/>);</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/>tmp[2]<sp/>=<sp/>dir[2]<sp/>+<sp/>div<sp/>*<sp/>(<sp/>cos(angle)*normalh[2]<sp/>+<sp/>sin(angle)*normalv[2]<sp/>);</highlight></codeline>
<codeline lineno="354"><highlight class="normal"></highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="math_8h_1a29911679af4275647fea8492f908bbd9" kindref="member">math_unit</ref>(tmp,<sp/>dir);</highlight></codeline>
<codeline lineno="356"><highlight class="normal"></highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>gamma<sp/>=<sp/><ref refid="physlib_8h_1a96bd4545feafc9d5ca44643a673e7623" kindref="member">physlib_gamma_Ekin</ref>(inj-&gt;<ref refid="structnbi__injector_1a0d88412779d6ce4f6842852577d64637" kindref="member">mass</ref>,<sp/>energy);</highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>absv<sp/><sp/>=<sp/>sqrt(<sp/>1.0<sp/>-<sp/>1.0<sp/>/<sp/>(gamma<sp/>*<sp/>gamma)<sp/>)<sp/>*<sp/><ref refid="consts_8h_1a48339a730ee12d23d732ee7ce96f0aa6" kindref="member">CONST_C</ref>;</highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/>vxyz[0]<sp/>=<sp/>absv<sp/>*<sp/>dir[0];</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/>vxyz[1]<sp/>=<sp/>absv<sp/>*<sp/>dir[1];</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/>vxyz[2]<sp/>=<sp/>absv<sp/>*<sp/>dir[2];</highlight></codeline>
<codeline lineno="362"><highlight class="normal">}</highlight></codeline>
<codeline lineno="363"><highlight class="normal"></highlight></codeline>
<codeline lineno="382" refid="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="nbi_8c_1ae7ff2e2a11abf55e0aa5023bc750a4ed" kindref="member">nbi_ionize</ref>(<ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>xyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref>*<sp/>vxyz,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>time,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">*<sp/>shinethrough,<sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>anum,</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>znum,<sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>mass,<sp/><ref refid="structB__field__data" kindref="compound">B_field_data</ref>*<sp/>Bdata,<sp/><ref refid="structplasma__data" kindref="compound">plasma_data</ref>*<sp/>plsdata,</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="structwall__data" kindref="compound">wall_data</ref>*<sp/>walldata,<sp/><ref refid="random_8h_1a103c9e22750b3fbab1ce5060f56f5100" kindref="member">random_data</ref>*<sp/>rng)<sp/>{</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="error_8h_1a3bca029fa2975420f00b89f3cb38872e" kindref="member">a5err</ref><sp/>err;</highlight></codeline>
<codeline lineno="386"><highlight class="normal"></highlight></codeline>
<codeline lineno="387"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>vnorm<sp/>=<sp/><ref refid="math_8h_1adfcdc12f390386bae35dfed59f73e247" kindref="member">math_norm</ref>(vxyz);</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>gamma<sp/>=<sp/><ref refid="physlib_8h_1ae912c3e48025bd66c3f2ec2228702941" kindref="member">physlib_gamma_vnorm</ref>(vnorm);</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>ekin<sp/><sp/>=<sp/><ref refid="physlib_8h_1aabf44d46945dc9b5eb25b2578db6be63" kindref="member">physlib_Ekin_gamma</ref>(mass,<sp/>gamma);</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>vhat[3];</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/><sp/><sp/>vhat[0]<sp/>=<sp/>vxyz[0]<sp/>/<sp/>vnorm;</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/><sp/><sp/>vhat[1]<sp/>=<sp/>vxyz[1]<sp/>/<sp/>vnorm;</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/>vhat[2]<sp/>=<sp/>vxyz[2]<sp/>/<sp/>vnorm;</highlight></codeline>
<codeline lineno="394"><highlight class="normal"></highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n_species<sp/><sp/><sp/><sp/><sp/><sp/><sp/>=<sp/><ref refid="plasma_8c_1a1e6c6d47aaf86678b5d8ef6a1b8764ae" kindref="member">plasma_get_n_species</ref>(plsdata);</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">*<sp/>pls_anum<sp/>=<sp/><ref refid="plasma_8c_1a144b6696944d31e7c187033341634d1b" kindref="member">plasma_get_species_anum</ref>(plsdata);</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal">*<sp/>pls_znum<sp/>=<sp/><ref refid="plasma_8c_1ab153d81eda7d78db2944b5463c53518d" kindref="member">plasma_get_species_znum</ref>(plsdata);</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>pls_temp[<ref refid="ascot5_8h_1a9a9ccddfec36bf0f49a168a9dcb8f87e" kindref="member">MAX_SPECIES</ref>],<sp/>pls_dens[<ref refid="ascot5_8h_1a9a9ccddfec36bf0f49a168a9dcb8f87e" kindref="member">MAX_SPECIES</ref>];</highlight></codeline>
<codeline lineno="399"><highlight class="normal"></highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>remaining<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>threshold<sp/>=<sp/><ref refid="random_8h_1a672a321bc1830eb349b31f110f5f6370" kindref="member">random_uniform</ref>(rng);</highlight></codeline>
<codeline lineno="402"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>ds<sp/>=<sp/>1e-3;</highlight></codeline>
<codeline lineno="403"><highlight class="normal"></highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>s<sp/>=<sp/>0.0;</highlight></codeline>
<codeline lineno="405"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>entered_plasma<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>exited_plasma<sp/><sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="407"><highlight class="normal"></highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(remaining<sp/>&gt;<sp/>threshold<sp/>&amp;&amp;<sp/>s<sp/>&lt;<sp/><ref refid="ascot5_8h_1a09caf7a570107ae78ad2aafcd12aa346" kindref="member">NBI_MAX_DISTANCE</ref>)<sp/>{</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>rate<sp/>=<sp/>0.0;</highlight></codeline>
<codeline lineno="411"><highlight class="normal"></highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>rpz[3];</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a484ec0cbb3628bc8451a4f82ba292803" kindref="member">math_xyz2rpz</ref>(xyz,<sp/>rpz);</highlight></codeline>
<codeline lineno="414"><highlight class="normal"></highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>psi,<sp/>rho[2];</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/><ref refid="B__field_8c_1a48c1f881a5f7fc9bf2d04edadfc2becf" kindref="member">B_field_eval_psi</ref>(&amp;psi,<sp/>rpz[0],<sp/>rpz[1],<sp/>rpz[2],<sp/>0.0,<sp/>Bdata);</highlight></codeline>
<codeline lineno="417"><highlight class="normal"></highlight></codeline>
<codeline lineno="418"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!err)<sp/>{</highlight></codeline>
<codeline lineno="419"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/><ref refid="B__field_8c_1a3e0114363493349f81a78142e70f2bd4" kindref="member">B_field_eval_rho</ref>(rho,<sp/>psi,<sp/>Bdata);</highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Check<sp/>for<sp/>wall<sp/>collisions<sp/>after<sp/>passing<sp/>through<sp/>separatrix</highlight></codeline>
<codeline lineno="422"><highlight class="comment"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*<sp/>twice<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="423"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!entered_plasma<sp/>&amp;&amp;<sp/>rho[0]<sp/>&lt;<sp/>1.0)<sp/>{</highlight></codeline>
<codeline lineno="424"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>entered_plasma<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="425"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="426"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(entered_plasma<sp/>&amp;&amp;<sp/>!exited_plasma<sp/>&amp;&amp;<sp/>rho[0]<sp/>&gt;=<sp/>1.0)<sp/>{</highlight></codeline>
<codeline lineno="427"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>exited_plasma<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="428"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="429"><highlight class="normal"></highlight></codeline>
<codeline lineno="430"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/><ref refid="plasma_8c_1abc2888177c42272b418317fa5dddb23a" kindref="member">plasma_eval_densandtemp</ref>(pls_dens,<sp/>pls_temp,<sp/>rho[0],<sp/>rpz[0],</highlight></codeline>
<codeline lineno="431"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rpz[1],<sp/>rpz[2],<sp/>time,<sp/>plsdata);</highlight></codeline>
<codeline lineno="432"><highlight class="normal"></highlight></codeline>
<codeline lineno="433"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!err)<sp/>{</highlight></codeline>
<codeline lineno="434"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>sigmav;</highlight></codeline>
<codeline lineno="435"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/><ref refid="suzuki_8c_1a3137723600419f37e26a80691bb5bb0f" kindref="member">suzuki_sigmav</ref>(</highlight></codeline>
<codeline lineno="436"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;sigmav,<sp/>ekin<sp/>/<sp/>anum,<sp/>pls_dens[0],<sp/>pls_temp[0],</highlight></codeline>
<codeline lineno="437"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>n_species-1,<sp/>&amp;(pls_dens[1]),<sp/>pls_anum,<sp/>pls_znum)<sp/>)<sp/>{</highlight></codeline>
<codeline lineno="438"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>err<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="439"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="440"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rate<sp/>=<sp/>pls_dens[0]<sp/>*<sp/>sigmav;</highlight></codeline>
<codeline lineno="441"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="442"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="443"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rate<sp/>=<sp/>0.0;<sp/></highlight><highlight class="comment">/*<sp/>Outside<sp/>the<sp/>plasma<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="444"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="445"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="446"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="447"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rate<sp/>=<sp/>0.0;<sp/></highlight><highlight class="comment">/*<sp/>Outside<sp/>the<sp/>magnetic<sp/>field<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="448"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="449"><highlight class="normal"></highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>s<sp/>+=<sp/>ds;</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>xyz[0]<sp/>+=<sp/>ds<sp/>*<sp/>vhat[0];</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>xyz[1]<sp/>+=<sp/>ds<sp/>*<sp/>vhat[1];</highlight></codeline>
<codeline lineno="453"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>xyz[2]<sp/>+=<sp/>ds<sp/>*<sp/>vhat[2];</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>remaining<sp/>*=<sp/>exp(-rate<sp/>*<sp/>ds);</highlight></codeline>
<codeline lineno="455"><highlight class="normal"></highlight></codeline>
<codeline lineno="456"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(exited_plasma)<sp/>{</highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>rpz2[3];<sp/></highlight><highlight class="comment">/*<sp/>New<sp/>position,<sp/>old<sp/>position<sp/>already<sp/>in<sp/>rpz<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="458"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="math_8h_1a484ec0cbb3628bc8451a4f82ba292803" kindref="member">math_xyz2rpz</ref>(xyz,<sp/>rpz2);</highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="ascot5_8h_1a11d147c64891830c9e79b3315b1b2e21" kindref="member">real</ref><sp/>w_coll;</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>tile<sp/>=<sp/><ref refid="wall_8c_1a66c9e2c7f3db0e3ccbf7507b45e4e5c2" kindref="member">wall_hit_wall</ref>(rpz[0],<sp/>rpz[1],<sp/>rpz[2],<sp/>rpz2[0],<sp/>rpz2[1],</highlight></codeline>
<codeline lineno="461"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>rpz2[2],<sp/>walldata,<sp/>&amp;w_coll);</highlight></codeline>
<codeline lineno="462"><highlight class="normal"></highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(tile<sp/>&gt;<sp/>0)<sp/>{</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Hit<sp/>wall<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*shinethrough<sp/>=<sp/>tile;</highlight></codeline>
<codeline lineno="466"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="470"><highlight class="normal"></highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">/*<sp/>Check<sp/>if<sp/>we&apos;ve<sp/>missed<sp/>the<sp/>plasma<sp/>entirely<sp/>*/</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="472"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(s<sp/>&lt;<sp/><ref refid="ascot5_8h_1a09caf7a570107ae78ad2aafcd12aa346" kindref="member">NBI_MAX_DISTANCE</ref>)<sp/>{</highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*shinethrough<sp/>=<sp/>0;</highlight></codeline>
<codeline lineno="474"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>*shinethrough<sp/>=<sp/>-1;</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="478"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="nbi.c"/>
  </compounddef>
</doxygen>
